<!DOCTYPE html>
<html>
<head>
    <title>Auth Debug Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.5.0/dist/umd/supabase.min.js"></script>
</head>
<body>
    <h1>Tale Forge Authentication Debug</h1>
    <div id="results"></div>
    
    <script>
        const supabaseUrl = 'https://fyihypkigbcmsxyvseca.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5aWh5cGtpZ2JjbXN4eXZzZWNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMzM3NjAsImV4cCI6MjA2NjgwOTc2MH0.4LgZRIaUTuVG2_ddX8jbg-XGceWiTvmjoJ0T3GCmrkg';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        const results = document.getElementById('results');
        
        async function checkAuth() {
            try {
                // Check current session
                const { data: { session }, error } = await supabase.auth.getSession();
                
                results.innerHTML = `
                    <h2>Authentication Status</h2>
                    <p><strong>Session exists:</strong> ${!!session}</p>
                    <p><strong>Access token exists:</strong> ${!!session?.access_token}</p>
                    <p><strong>User ID:</strong> ${session?.user?.id || 'None'}</p>
                    <p><strong>User Email:</strong> ${session?.user?.email || 'None'}</p>
                    <p><strong>Token (first 50 chars):</strong> ${session?.access_token?.substring(0, 50) || 'None'}...</p>
                    <p><strong>Session Error:</strong> ${error?.message || 'None'}</p>
                    
                    <h2>Test Story Creation</h2>
                    <button onclick="testStoryCreation()">Test Create Story API</button>
                    <div id="createResult"></div>
                `;
                
                return session;
            } catch (err) {
                results.innerHTML = `<p style="color: red;">Error: ${err.message}</p>`;
            }
        }
        
        async function testStoryCreation() {
            const session = await supabase.auth.getSession();
            const createResult = document.getElementById('createResult');
            
            if (!session.data?.session?.access_token) {
                createResult.innerHTML = '<p style="color: red;">No access token - user not authenticated</p>';
                return;
            }
            
            const testData = {
                title: 'Debug Test Story',
                description: 'Test story',
                genre: 'fantasy',
                target_age: 7,
                theme: 'adventure',
                setting: 'forest',
                characters: [{ name: 'Test', role: 'hero' }],
                conflict: 'test',
                quest: 'test',
                moral_lesson: 'test',
                additional_details: '',
                words_per_chapter: 70
            };
            
            try {
                const response = await fetch('https://fyihypkigbcmsxyvseca.supabase.co/functions/v1/create-story', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.data.session.access_token}`,
                        'apikey': supabaseKey
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.text();
                createResult.innerHTML = `
                    <h3>API Response</h3>
                    <p><strong>Status:</strong> ${response.status}</p>
                    <p><strong>Response:</strong></p>
                    <pre style="background: #f5f5f5; padding: 10px; overflow-x: scroll;">${result}</pre>
                `;
            } catch (err) {
                createResult.innerHTML = `<p style="color: red;">Error: ${err.message}</p>`;
            }
        }
        
        // Check auth on page load
        checkAuth();
    </script>
</body>
</html>